/**
 *  Copyright 2012 Rackspace
 *
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 *
 */

var log = require('logmagic').local('tests.test-orm-index-cleanup');

var async = require('async');

var cutils = require('../lib/orm/utils');
var constants = require('../lib/orm/constants');
var Account = require('../examples/models/account').Account;
var PaginatedIndexIterator = require('../lib/orm/iterator').PaginatedIndexIterator;
var common = require('./common');


exports['setUp'] = common.setUp;
exports['tearDown'] = common.tearDown;


exports['test_dangling_account_index'] = function(test, assert) {
  var ctx = {'log': log, 'account': new Account({ _key: 'acOne'})},
      pool = cutils.getConnPool();

  async.series([
    // Create an index for external id 91169 pointing to account acWHATEVER (doesn't exist)
    function(callback) {
      var query = 'UPDATE ? USING CONSISTENCY ONE SET ?=NULL WHERE KEY=?',
          args = ['account_external_idx', 'acWHATEVER:acWHATEVER', '91169'];

      pool.execute(ctx, query, args, function(err) {
        assert.ifError(err);
        callback();
      });
    },

    // Attempt to use external id 91169, index should be removed
    function(callback) {
      var iter = new PaginatedIndexIterator(ctx, Account, null, {'clean': true});
      iter.getIndex('external_idx', '91169', {'ending': constants.END_TOKEN});

      iter.on('error', callback);
      iter.on('end', function() {
        callback();
      });
    },

    // Read out the index, make sure that the index has been removed
    function(callback) {
      var query = 'SELECT * FROM ? USING CONSISTENCY ONE WHERE KEY=?',
          args = ['account_external_idx', '91169'];

      pool.execute(ctx, query, args, function(err, result) {
        assert.ifError(err);
        assert.equal(result[0].cols.length, 0);
        callback();
      });
    }
  ],

  function(err) {
    assert.ifError(err);
    test.finish();
  });
};
