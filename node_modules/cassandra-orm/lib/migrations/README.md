# Migration Framework

Migration framework is responsible for performing model migrations. Example
migrations:

* adding a new field to the model
* removing a field from the model
* changing data format of some field

## Terminology

* `current operational version` - version of the object with which we
  currently work in memory. This version must always be <= `_version` attribute
  on the object currently stored in the database.

* `last migration version` - latest available version of the migrate for a
  model. Must be >= `current operational version`.

* `initial migation`, `initial migration version` - first migration for a model.

## Implementation details

* We store a special `_version` field with each object in the database. This
  version determines current version of the object stored in the database.

* Only a single version of the object is stored in memory.

* When working with an object in memory we always work with the current
  operational version. current operational versions for each model are defined
  in an environment variable and are always <= `_version` attribute stored in
  the database.

* Current operational version for each model is stored on a model as a
  `operationalVersion` attribute.

* Migration files are stored in `migrations/<model name>/` directory

* Migrations are numbered in the increasing order (e.g. 0, 1, 2, ..).
  First version of the object has a number `0` and the name of the migration
  file is `0000_initial`.

* Each migration file exports the following properties:
  * `FRAMEWORK_VERSION` - version of the migration framework which was used to
    generate this migration
  * `TIMESTAMP` - timestamp when the migration has been generated
  * `VERSION` - migration version
  * `FIELDS` - fields on the model at version `version`
  * `forward` - function which is called with an object of version `n-1` and is
    responsible of converting it to the version `n`.
  * `backward` - function which is called with an object of version `n` and is
    responsible of converting it to the version `n-1`.

Note #1: `forward` and `backward` must only be implemented if you want to rename
a field or perform a data migration (e.g. replace a field value).

Note #2: Only `forward` and `backward` methods are editable by the user!

## Using the command line tool

Migration files are generated automatically used a `bin/cass-migrations` tool. This
tool also automatically creates a current directory structure for all the
models.

### Creating initial migration files

`bin/cass-migrations -a init -m <model name|all>`

This will generate migrations directory structure and initial migration files
for a single model or all the models if `-m all` option is used.

This command only needs to be used first time and when adding a new model.

## Generating migration files (after changing a model)

`bin/cass-migrations -a auto -m <model name|all> -n <migration_name> [-y]`

When you changed a model or want to create a migration you need to use this
command. This command will write out a migration file with the fields which are
currently stored on the object. Version will automatically be determined by
adding `1` to the latest available migration version.

Note: In some cases you also want to create a migration even-though you didn't
change any field on the model. Good example of this is changing a field value
from a JavaScript date format to a Unix timestamp. In this case you need to use
`-y` option.

## Inspecting changes

`bin/cass-migrations -a inspect -m <model name|all>`

This command allows you to inspect differences between current model version and
the last available migration.

## Deployment

* Update the code, add migrations
* Deploy new code with migrations
* When a full roll-out has been performed, update `operationalVersion` attribute on
  all the models which have been updated. After this is done, deploy a new
  version of the code.

## Limitations

* We only store a single version of the object in the database which means once
  a migration which has removed a field is saved into a database, there is no
  way back.

## Example

Consider we have a model `TestModel` with 4 migration files:

* `0000_initial.js`
* `0001_rename_name_to_label.js`
* `0002_change_date_to_unix_timestamp.js`
* `0003_change_url_default_value.js`

### Scenario 1: object in the database has a `_version=0` and
`TestModel.operationalVersion=0`.

In this case when an object is pulled from the database and saved to it, no
migrations are performed because the object is already at the latest version.

### Scenario 2: object in the database has a `_version=0` and
`TestModel.operationalVersion=2`.

In this case when we pull an object from the database and save it back in, the
following migrations will be ran:

* `0001_rename_name_to_label`
* `0002_change_date_to_unix_timestamp`

When the object is saved to the database, `_version` attribute will also be set
to `2` (`TestModel.operationalVersion`).

### Scenario 3: object in the database has a `_version=3` and
`TestModel.operationalVersion=0`.

In this case the following migrations will be ran when the object is pulled from
the database and saved back to it:

* `0003_change_url_default_value`
* `0002_change_date_to_unix_timestamp`
* `0001_rename_name_to_label`

When the object is saved to the database, `_version` attribute will also be set
to `0` (`TestModel.operationalVersion`).
